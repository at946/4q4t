image: tmaier/docker-compose:latest

services:
  - docker:dind

rspec:
  stage: test
  script:
    - docker-compose build
    - docker-compose run web yarn install --check-files
    - docker-compose run web rails db:create
    - docker-compose run web rails db:migrate
    - docker-compose up -d chrome
    - docker-compose run web rspec

deploy:
  stage: deploy
  script:
    # - docker run --rm -e HEROKU_API_KEY=$HEROKU_API_KEY wingrunr21/alpine-heroku-cli list
    - docker run --rm -e HEROKU_API_KEY=$HEROKU_API_KEY wingrunr21/alpine-heroku-cli container:push web -a app-4q4t